<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anekdot.io - Kartu Belajar</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #f0f4f8;
            color: #333;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: #fff;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .btn-back { color: #555; font-size: 20px; text-decoration: none; margin-right: 15px; }
        .header-title { font-weight: 600; font-size: 16px; color: #2575fc; flex-grow: 1; }
        .poin-badge {
            background: #ffb300; color: #fff; padding: 5px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 700;
            display: flex; align-items: center; gap: 5px;
        }

        /* Konten Pengantar */
        .intro-section { padding: 20px; background: linear-gradient(to bottom, #f8faff, #fff); }
        .intro-text {
            font-size: 13px; color: #444; line-height: 1.6; margin-bottom: 15px;
            padding: 15px; background: #e3f2fd; border-radius: 12px;
            border-left: 4px solid #2575fc;
        }
        .action-call { text-align: center; font-weight: 600; color: #2575fc; font-size: 14px; font-style: italic; }

        /* Area Game */
        .game-area { padding: 0 20px 30px; display: none; flex-direction: column; align-items: center; }

        /* KARTU PORTRAIT */
        .card-container {
            width: 100%;
            max-width: 300px; /* Ukuran Portrait */
            height: 420px;     /* Lebih tinggi agar Portrait */
            perspective: 1000px;
            margin: 20px auto 30px;
        }

        .card-inner {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.8s; transform-style: preserve-3d;
        }
        .card-inner.is-flipped { transform: rotateY(180deg); }

        .card-front, .card-back {
            width: 100%; height: 100%; position: absolute;
            backface-visibility: hidden; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden;
            display: flex; flex-direction: column; background: #fff;
            border: 1px solid #eee;
        }

        .card-back { transform: rotateY(180deg); background: #f0fff4; border: 2px solid #4caf50; }

        .card-img { width: 100%; height: 65%; object-fit: cover; background: #f9f9f9; }
        .card-question {
            padding: 20px; text-align: center; font-size: 15px;
            font-weight: 600; color: #333; flex-grow: 1;
            display: flex; align-items: center; justify-content: center;
        }

        /* Input Area */
        .input-area { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .input-jawab {
            width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px;
            font-size: 16px; text-align: center; outline: none; transition: 0.3s;
            text-transform: uppercase; 
        }
        .input-jawab:focus { border-color: #2575fc; background: #f8fbff; }
        .btn-kirim {
            width: 100%; padding: 15px; background: #2575fc; color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
            cursor: pointer; box-shadow: 0 4px 10px rgba(37, 117, 252, 0.3);
        }

        .feedback-msg { text-align: center; font-size: 14px; font-weight: 600; margin-top: 10px; }
        .msg-error { color: #f44336; }
        .msg-success { color: #4caf50; }

        .extra-controls { display: none; width: 100%; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .btn-outline, .btn-next { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-outline { background: transparent; border: 2px solid #2575fc; color: #2575fc; }
        .btn-next { background: #4caf50; border: none; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* CUSTOM MODAL POPUP */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; align-items: center;
            justify-content: center; z-index: 1000; padding: 20px;
        }
        .modal-box {
            background: #fff; padding: 30px; border-radius: 20px;
            max-width: 350px; width: 100%; text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-box i { font-size: 50px; color: #ffb300; margin-bottom: 15px; }
        .modal-box h3 { margin-bottom: 10px; font-size: 18px; }
        .modal-box p { font-size: 14px; color: #666; margin-bottom: 20px; }
        .btn-modal {
            background: #2575fc; color: #fff; border: none; padding: 10px 25px;
            border-radius: 10px; font-weight: 600; cursor: pointer;
        }

        /* Loading Spinner */
        .loading-data { text-align: center; padding: 50px 20px; color: #2575fc; font-weight: 600; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <a href="dashboard.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
            <div class="header-title">Kartu Belajar</div>
            <div class="poin-badge">
                <i class="fa-solid fa-star"></i> <span id="skorUser">0</span>
            </div>
        </header>

        <section class="intro-section">
            <div class="intro-text">
                <strong>Teks Anekdot</strong> adalah cerita singkat yang menarik karena lucu dan mengesankan, biasanya mengenai orang penting dan berdasarkan kejadian nyata untuk menyampaikan <strong>kritikan</strong>.
            </div>
            <div class="action-call">Dijawab yang bener ya, jangan asal-asalan!</div>
        </section>

        <div class="loading-data" id="loadingData">
            <i class="fa-solid fa-spinner fa-spin"></i><br>Menyiapkan kartu...
        </div>

        <section class="game-area" id="gameArea">
            <div class="card-container">
                <div class="card-inner" id="flashcard">
                    <div class="card-front">
                        <img src="" id="imgDepan" class="card-img" alt="Soal">
                        <div class="card-question" id="teksSoal"></div>
                    </div>
                    <div class="card-back">
                        <img src="" id="imgBelakang" class="card-img" alt="Jawaban">
                        <div class="card-question" style="color: #2e7d32;">
                            Jawaban: <br><strong id="teksJawabanBenar"></strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area" id="areaInput">
                <input type="text" id="inputJawab" class="input-jawab" placeholder="Jawab di sini..." autocomplete="off">
                <button class="btn-kirim" id="btnKirim">Kirim Jawaban</button>
            </div>

            <div class="feedback-msg" id="pesanFeedback"></div>

            <div class="extra-controls" id="areaKontrolLanjut">
                <button class="btn-outline" id="btnBalikKartu">Cek Soal</button>
                <button class="btn-next" id="btnNext">Lanjut <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </section>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-box">
            <i class="fa-solid fa-circle-check"></i>
            <h3 id="modalTitle">Selesai!</h3>
            <p id="modalDesc">Kamu sudah menjawab semua kartu dengan mantap.</p>
            <button class="btn-modal" onclick="tutupModal()">Oke, Gas!</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhLMOes8_bVkE22fh2a_pQWiytG3RZY0Q",
            authDomain: "juararc-503f9.firebaseapp.com",
            projectId: "juararc-503f9",
            storageBucket: "juararc-503f9.firebasestorage.app",
            messagingSenderId: "306187241171",
            appId: "1:306187241171:web:70285c8b2643acd0533626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let bankSoal = [];
        let soalTersedia = [];
        let soalSaatIni = null;
        let skor = parseInt(sessionStorage.getItem('skorLocal')) || 0; 
        const userID = sessionStorage.getItem('userID');
        let userDocRef = null;

        const loadingData = document.getElementById('loadingData');
        const gameArea = document.getElementById('gameArea');
        const flashcard = document.getElementById('flashcard');
        const inputJawab = document.getElementById('inputJawab');
        const btnKirim = document.getElementById('btnKirim');
        const pesanFeedback = document.getElementById('pesanFeedback');
        const areaInput = document.getElementById('areaInput');
        const areaKontrolLanjut = document.getElementById('areaKontrolLanjut');
        const skorElement = document.getElementById('skorUser');

        document.addEventListener('DOMContentLoaded', async () => {
            const userName = sessionStorage.getItem('userName');
            if (!userName || !userID) { window.location.href = 'index.html'; return; }
            document.getElementById('namaUser').textContent = userName;
            skorElement.textContent = skor;

            inputJawab.addEventListener('input', function() { this.value = this.value.toUpperCase(); });
            await siapkanDataGame();
        });

        // FUNGSI CUSTOM MODAL
        window.bukaModal = (title, desc, icon = "fa-circle-check") => {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalDesc').textContent = desc;
            document.querySelector('.modal-box i').className = `fa-solid ${icon}`;
            document.getElementById('modalOverlay').style.display = 'flex';
        };
        window.tutupModal = () => {
            document.getElementById('modalOverlay').style.display = 'none';
            tampilkanSoalBaru();
        };

        async function siapkanDataGame() {
            try {
                const qUser = query(collection(db, "users_session"), where("userID", "==", userID));
                const userSnapshot = await getDocs(qUser);
                if (!userSnapshot.empty) {
                    userDocRef = userSnapshot.docs[0].ref;
                    const skorFirebase = userSnapshot.docs[0].data().skor || 0;
                    if (skorFirebase > skor) { skor = skorFirebase; skorElement.textContent = skor; }
                }

                const soalSnapshot = await getDocs(collection(db, "bank_soal_belajar"));
                if (soalSnapshot.empty) {
                    loadingData.innerHTML = "Belum ada kartu dari Admin.";
                    return;
                }

                soalSnapshot.forEach(doc => bankSoal.push(doc.data()));
                soalTersedia = [...bankSoal];
                loadingData.style.display = 'none';
                gameArea.style.display = 'flex';
                tampilkanSoalBaru();
            } catch (error) {
                loadingData.innerHTML = "Gagal terhubung ke database.";
            }
        }

        function tampilkanSoalBaru() {
            if (soalTersedia.length === 0) {
                bukaModal("Hebat!", "Semua kartu sudah kamu babat habis. Kita putar lagi dari awal ya!", "fa-trophy");
                soalTersedia = [...bankSoal];
                return;
            }

            const indexAcak = Math.floor(Math.random() * soalTersedia.length);
            soalSaatIni = soalTersedia[indexAcak];
            soalTersedia.splice(indexAcak, 1);

            document.getElementById('imgDepan').src = soalSaatIni.imgDepan;
            document.getElementById('teksSoal').textContent = soalSaatIni.pertanyaan;
            document.getElementById('imgBelakang').src = soalSaatIni.imgBelakang;
            document.getElementById('teksJawabanBenar').textContent = soalSaatIni.jawaban;

            flashcard.classList.remove('is-flipped');
            inputJawab.value = '';
            pesanFeedback.innerHTML = '';
            areaInput.style.display = 'flex';
            areaKontrolLanjut.style.display = 'none';
            inputJawab.focus();
        }

        btnKirim.addEventListener('click', async () => {
            const jUser = inputJawab.value.trim().toUpperCase();
            const jAsli = soalSaatIni.jawaban.trim().toUpperCase();

            if (!jUser) { pesanFeedback.innerHTML = '<span class="msg-error">Diisi dulu, jangan dikosongin!</span>'; return; }

            if (jUser === jAsli) {
                pesanFeedback.innerHTML = '<span class="msg-success">Mantap! Jawabanmu bener banget.</span>';
                skor += 10;
                skorElement.textContent = skor;
                sessionStorage.setItem('skorLocal', skor);
                if (userDocRef) await updateDoc(userDocRef, { skor: skor });

                flashcard.classList.add('is-flipped');
                areaInput.style.display = 'none';
                areaKontrolLanjut.style.display = 'flex';
            } else {
                pesanFeedback.innerHTML = '<span class="msg-error">Yah, salah. Fokus dong, jangan asal!</span>';
                inputJawab.style.transform = "translateX(-5px)";
                setTimeout(() => inputJawab.style.transform = "translateX(5px)", 100);
                setTimeout(() => inputJawab.style.transform = "translateX(0)", 200);
            }
        });

        document.getElementById('btnNext').addEventListener('click', tampilkanSoalBaru);
        document.getElementById('btnBalikKartu').addEventListener('click', () => {
            flashcard.classList.toggle('is-flipped');
            document.getElementById('btnBalikKartu').textContent = flashcard.classList.contains('is-flipped') ? "Cek Soal" : "Cek Jawaban";
        });
    </script>
</body>
</html>
