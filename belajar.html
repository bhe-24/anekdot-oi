<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anekdot.io - Kartu Belajar</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        body { background: #f0f4f8; color: #333; min-height: 100vh; }

        .app-container {
            width: 100%; max-width: 480px; margin: 0 auto; min-height: 100vh;
            background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative; display: flex; flex-direction: column;
        }

        header {
            background: #fff; padding: 15px 20px; display: flex; align-items: center;
            border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10;
        }

        .btn-back { color: #555; font-size: 20px; text-decoration: none; margin-right: 15px; }
        .header-title { font-weight: 600; font-size: 16px; color: #2575fc; flex-grow: 1; }
        .poin-badge {
            background: #ffb300; color: #fff; padding: 5px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 700;
            display: flex; align-items: center; gap: 5px;
        }

        .intro-section { padding: 20px; background: linear-gradient(to bottom, #f8faff, #fff); }
        .intro-text {
            font-size: 13px; color: #444; line-height: 1.6; margin-bottom: 10px;
            padding: 15px; background: #e3f2fd; border-radius: 12px;
            border-left: 4px solid #2575fc;
        }
        .action-call { text-align: center; font-weight: 600; color: #2575fc; font-size: 14px; font-style: italic; }

        /* KARTU PORTRAIT */
        .game-area { padding: 0 20px 30px; display: none; flex-direction: column; align-items: center; }
        .card-container {
            width: 100%; max-width: 280px; height: 400px; 
            perspective: 1000px; margin: 20px auto;
        }

        .card-inner {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.8s; transform-style: preserve-3d;
        }
        .card-inner.is-flipped { transform: rotateY(180deg); }

        .card-front, .card-back {
            width: 100%; height: 100%; position: absolute;
            backface-visibility: hidden; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden;
            display: flex; flex-direction: column; background: #fff;
        }
        .card-back { transform: rotateY(180deg); background: #f0fff4; border: 2px solid #4caf50; }

        .card-img { width: 100%; height: 60%; object-fit: cover; background: #f9f9f9; }
        .card-question {
            padding: 15px; text-align: center; font-size: 14px;
            font-weight: 600; color: #333; flex-grow: 1;
            display: flex; align-items: center; justify-content: center;
        }

        .input-area { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .input-jawab {
            width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 12px;
            font-size: 16px; text-align: center; outline: none; text-transform: uppercase; 
        }
        .btn-kirim {
            width: 100%; padding: 14px; background: #2575fc; color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
        }

        .feedback-msg { text-align: center; font-size: 13px; font-weight: 600; margin-top: 10px; min-height: 20px;}
        .msg-error { color: #f44336; }
        .msg-success { color: #4caf50; }

        .extra-controls { display: none; width: 100%; gap: 10px; margin-top: 15px; }
        .btn-outline, .btn-next { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .btn-outline { background: transparent; border: 2px solid #2575fc; color: #2575fc; }
        .btn-next { background: #4caf50; border: none; color: white; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; align-items: center;
            justify-content: center; z-index: 2000;
        }
        .modal-box {
            background: #fff; padding: 30px; border-radius: 20px;
            max-width: 320px; width: 90%; text-align: center;
        }
        .modal-box i { font-size: 50px; color: #ffb300; margin-bottom: 15px; }
        .btn-modal {
            background: #2575fc; color: #fff; border: none; padding: 10px 30px;
            border-radius: 10px; font-weight: 600; margin-top: 20px;
        }

        .loading-data { text-align: center; padding: 100px 20px; color: #2575fc; }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <a href="dashboard.html" class="btn-back"><i class="fa-solid fa-arrow-left"></i></a>
            <div class="header-title">Kartu Belajar</div>
            <div class="poin-badge">
                <i class="fa-solid fa-star"></i> <span id="skorUser">0</span>
            </div>
        </header>

        <section class="intro-section">
            <div class="intro-text">
                <strong>Teks Anekdot</strong> adalah cerita singkat yang lucu untuk menyindir atau mengkritik sesuatu.
            </div>
            <div class="action-call">Dijawab yang bener ya, jangan asal-asalan!</div>
        </section>

        <div class="loading-data" id="loadingData">
            <i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>Menyiapkan kartu...
        </div>

        <section class="game-area" id="gameArea">
            <div class="card-container">
                <div class="card-inner" id="flashcard">
                    <div class="card-front">
                        <img src="" id="imgDepan" class="card-img" alt="Soal">
                        <div class="card-question" id="teksSoal"></div>
                    </div>
                    <div class="card-back">
                        <img src="" id="imgBelakang" class="card-img" alt="Jawaban">
                        <div class="card-question" style="color: #2e7d32;">
                            Jawaban: <br><strong id="teksJawabanBenar"></strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area" id="areaInput">
                <input type="text" id="inputJawab" class="input-jawab" placeholder="Jawab di sini..." autocomplete="off">
                <button class="btn-kirim" id="btnKirim">Kirim Jawaban</button>
            </div>
            <div class="feedback-msg" id="pesanFeedback"></div>
            <div class="extra-controls" id="areaKontrolLanjut">
                <button class="btn-outline" id="btnBalikKartu">Cek Soal</button>
                <button class="btn-next" id="btnNext">Lanjut <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </section>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-box">
            <i class="fa-solid fa-trophy"></i>
            <h3>Hebat!</h3>
            <p>Semua kartu sudah kamu babat habis. Kita putar lagi dari awal ya!</p>
            <button class="btn-modal" id="btnTutupModal">Oke, Gas!</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhLMOes8_bVkE22fh2a_pQWiytG3RZY0Q",
            authDomain: "juararc-503f9.firebaseapp.com",
            projectId: "juararc-503f9",
            storageBucket: "juararc-503f9.firebasestorage.app",
            messagingSenderId: "306187241171",
            appId: "1:306187241171:web:70285c8b2643acd0533626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let bankSoal = [];
        let soalTersedia = [];
        let soalSaatIni = null;
        let skor = parseInt(sessionStorage.getItem('skorLocal')) || 0; 
        const userID = sessionStorage.getItem('userID');
        let userDocRef = null;

        const loadingData = document.getElementById('loadingData');
        const gameArea = document.getElementById('gameArea');
        const flashcard = document.getElementById('flashcard');
        const inputJawab = document.getElementById('inputJawab');
        const btnKirim = document.getElementById('btnKirim');
        const pesanFeedback = document.getElementById('pesanFeedback');
        const areaInput = document.getElementById('areaInput');
        const areaKontrolLanjut = document.getElementById('areaKontrolLanjut');
        const skorElement = document.getElementById('skorUser');
        const modalOverlay = document.getElementById('modalOverlay');

        async function init() {
            if (!userID) { window.location.href = 'index.html'; return; }
            skorElement.textContent = skor;
            
            try {
                // Ambil User Ref
                const qUser = query(collection(db, "users_session"), where("userID", "==", userID));
                const userSnap = await getDocs(qUser);
                if (!userSnap.empty) userDocRef = userSnap.docs[0].ref;

                // Ambil Soal
                const soalSnap = await getDocs(collection(db, "bank_soal_belajar"));
                soalSnap.forEach(doc => bankSoal.push(doc.data()));
                
                if (bankSoal.length === 0) {
                    loadingData.innerHTML = "Belum ada soal dari Admin.";
                    return;
                }

                soalTersedia = [...bankSoal];
                loadingData.style.display = 'none';
                gameArea.style.display = 'flex';
                tampilkanSoalBaru();
            } catch (e) {
                loadingData.innerHTML = "Koneksi Error.";
            }
        }

        function tampilkanSoalBaru() {
            if (soalTersedia.length === 0) {
                modalOverlay.style.display = 'flex';
                soalTersedia = [...bankSoal];
                return;
            }

            const idx = Math.floor(Math.random() * soalTersedia.length);
            soalSaatIni = soalTersedia[idx];
            soalTersedia.splice(idx, 1);

            document.getElementById('imgDepan').src = soalSaatIni.imgDepan;
            document.getElementById('teksSoal').textContent = soalSaatIni.pertanyaan;
            document.getElementById('imgBelakang').src = soalSaatIni.imgBelakang;
            document.getElementById('teksJawabanBenar').textContent = soalSaatIni.jawaban;

            flashcard.classList.remove('is-flipped');
            inputJawab.value = '';
            pesanFeedback.innerHTML = '';
            areaInput.style.display = 'flex';
            areaKontrolLanjut.style.display = 'none';
            inputJawab.focus();
        }

        btnKirim.onclick = async () => {
            const jUser = inputJawab.value.trim().toUpperCase();
            const jAsli = soalSaatIni.jawaban.trim().toUpperCase();

            if (!jUser) { 
                pesanFeedback.innerHTML = '<span class="msg-error">Diisi dulu, jangan dikosongin!</span>'; 
                return; 
            }

            if (jUser === jAsli) {
                pesanFeedback.innerHTML = '<span class="msg-success">Mantap! Jawabanmu bener banget.</span>';
                skor += 10;
                skorElement.textContent = skor;
                sessionStorage.setItem('skorLocal', skor);
                if (userDocRef) updateDoc(userDocRef, { skor: skor });

                flashcard.classList.add('is-flipped');
                areaInput.style.display = 'none';
                areaKontrolLanjut.style.display = 'flex';
            } else {
                pesanFeedback.innerHTML = '<span class="msg-error">Yah, salah. Fokus dong, jangan asal!</span>';
            }
        };

        document.getElementById('btnNext').onclick = tampilkanSoalBaru;
        document.getElementById('btnBalikKartu').onclick = () => {
            flashcard.classList.toggle('is-flipped');
        };
        document.getElementById('btnTutupModal').onclick = () => {
            modalOverlay.style.display = 'none';
            tampilkanSoalBaru();
        };

        inputJawab.oninput = () => inputJawab.value = inputJawab.value.toUpperCase();

        init();
    </script>
</body>
</html>
